{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'tui-image-editor.css' %}">
<link rel="stylesheet" href="{% static 'tui-color-picker.css' %}">

<div class="min-h-screen bg-gray-900 text-white px-4 py-10">
  <h1 class="text-4xl font-bold text-center mb-10">Edit Your Post</h1>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 max-w-7xl mx-auto">
    
    <!-- Image Editor -->
    <div class="bg-white rounded-lg shadow-xl overflow-hidden border border-gray-300 h-[600px]">
      <div id="tui-image-editor-container" class="h-full"></div>
    </div>

    <!-- Text Editor & Controls -->
    <div class="bg-gray-800 rounded-lg shadow-lg p-6 flex flex-col justify-between">
      <div>
        <h2 class="text-2xl font-semibold mb-4">Edit Caption</h2>
        <textarea id="post-text" class="w-full h-60 p-4 rounded-lg text-black" placeholder="Enter your caption here...">{{ post.text }}</textarea>
      </div>

      <div class="mt-6 space-y-4">
        <button id="save-edited-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg font-semibold transition duration-300">
          Save Changes
        </button>
        <div id="loadingSpinner" class="text-accent-100 text-center hidden animate-pulse">Saving your changes...</div>
      </div>
    </div>

  </div>
</div>

<script src="{% static 'tui-color-picker.js' %}"></script>
<script src="{% static 'tui-image-editor.js' %}"></script>

<script>
  const imageEditor = new tui.ImageEditor('#tui-image-editor-container', {
    includeUI: {
      loadImage: {
        path: "{% url 'clientManagement:proxy_image' %}?url={{ image_url|urlencode }}",
        name: 'ToBeEdited'
      },
      menu: ['crop', 'flip', 'rotate', 'draw', 'shape', 'icon', 'text', 'filter'],
      uiSize: { width: '100%', height: '100%' },
      menuBarPosition: 'bottom'
    },
    cssMaxWidth: 500,
    cssMaxHeight: 500,
    selectionStyle: {
      cornerSize: 20,
      rotatingPointOffset: 70
    }
  });

  function getCookie(name) {
    const cookie = document.cookie.split('; ').find(row => row.startsWith(name + '='));
    return cookie ? decodeURIComponent(cookie.split('=')[1]) : null;
  }

  function dataURLtoBlob(dataurl) {
    const [header, base64] = dataurl.split(',');
    const mime = header.match(/:(.*?);/)[1];
    const binary = atob(base64);
    const array = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) array[i] = binary.charCodeAt(i);
    return new Blob([array], { type: mime });
  }

  document.getElementById('save-edited-btn').addEventListener('click', () => {
    const dataURL = imageEditor.toDataURL();
    const caption = document.getElementById('post-text').value;
    const spinner = document.getElementById('loadingSpinner');
    spinner.classList.remove('hidden');

    const formData = new FormData();
    formData.append('edited_image', dataURLtoBlob(dataURL), 'edited_image.png');
    formData.append('text', caption);

    fetch("{% url 'clientManagement:apply_edit' post.id %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
      body: formData
    })
    .then(res => {
      if (!res.ok) throw new Error(res.statusText);
      return res.text();
    })
    .then(() => {
      spinner.innerText = 'Changes saved! Redirecting...';
      setTimeout(() => window.location.href = "{% url 'clientManagement:content_library' %}", 1200);
    })
    .catch(error => {
      console.error('Error saving changes:', error);
      spinner.classList.add('hidden');
      alert('Something went wrong. Try again.');
    });
  });
</script>
{% endblock %}