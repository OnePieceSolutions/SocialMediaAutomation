{# clientManagement/templates/clientManagement/edit_image.html #}
{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'tui-image-editor.css' %}">
<link rel="stylesheet" href="{% static 'tui-color-picker.css' %}">

<div id="tui-image-editor-container" style="width: 100%; height: 600px;"></div>
<div style="margin-top: 1rem; text-align: center;">
  <button id="save-edited-btn" class="btn btn-primary">Save Edited Image</button>
</div>

<script src="{% static 'tui-color-picker.js' %}"></script>
<script src="{% static 'tui-image-editor.js' %}"></script>
<script>
  // 1) Instantiate TUI Image Editor
  const imageEditor = new tui.ImageEditor('#tui-image-editor-container', {
    includeUI: {
      loadImage: {
        path: "{% url 'clientManagement:proxy_image' %}?url={{ image_url|urlencode }}",
        name: 'ToBeEdited'
      },
      menu: ['crop', 'flip', 'rotate', 'draw', 'shape', 'icon', 'text', 'filter'],
      uiSize: { width: '100%', height: '100%' },
      menuBarPosition: 'bottom'
    },
    cssMaxWidth: 800,
    cssMaxHeight: 600,
    selectionStyle: {
      cornerSize: 20,
      rotatingPointOffset: 70
    }
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  function dataURLtoBlob(dataurl) {
    const arr = dataurl.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while (n--) {
      u8arr[n] = bstr.charCodeAt(n);
    }
    return new Blob([u8arr], { type: mime });
  }
  document.getElementById('save-edited-btn').addEventListener('click', () => {
    const dataURL = imageEditor.toDataURL();
    if (!dataURL) {
      alert('Could not extract the edited image.');
      return;
    }
    const blob = dataURLtoBlob(dataURL);
    const formData = new FormData();
    formData.append('edited_image', blob, 'edited_image.png');
    fetch("{% url 'clientManagement:apply_edit' post.id %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken
      },
      body: formData
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      return response.text();
    })
    .then(() => {
      alert('Image saved successfully! Redirecting to Content Libraryâ€¦');
      window.location.href = "{% url 'clientManagement:content_library' %}";
    })
    .catch(err => {
      console.error('Error uploading edited image:', err);
      alert('Failed to save edited image.');
    });
  });
</script>
{% endblock %}
